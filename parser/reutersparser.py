"""
Code adapted from
http://scikit-learn.org/stable/auto_examples/applications/plot_out_of_core_classification.html
"""
from glob import glob
import os.path
import re

from HTMLParser import HTMLParser

class ReutersParser(HTMLParser):
  """Utility class to parse a SGML file and yield documents one at a time."""

  def __init__(self, encoding='latin-1'):
    HTMLParser.__init__(self)
    self._reset()
    self.encoding = encoding

  def handle_starttag(self, tag, attrs):
    method = 'start_' + tag
    getattr(self, method, lambda x: None)(attrs)

  def handle_endtag(self, tag):
    method = 'end_' + tag
    getattr(self, method, lambda: None)()

  def _reset(self):
    self.in_title = 0
    self.in_body = 0
    self.in_topics = 0
    self.in_topic_d = 0
    self.title = ""
    self.body = ""
    self.topics = []
    self.topic_d = ""
    self.attributes = {}

  def parse(self, fd):
    self.docs = []
    for chunk in fd:
        self.feed(chunk.decode(self.encoding))
        for doc in self.docs:
            yield doc
        self.docs = []
    self.close()

  def handle_data(self, data):
    if self.in_body:
        self.body += data
    elif self.in_title:
        self.title += data
    elif self.in_topic_d:
        self.topic_d += data

  def start_reuters(self, attributes):
    self.attributes = dict(attributes) # Attributes is a list of pairs

  def end_reuters(self):
    self.body = re.sub(r'\s+', r' ', self.body)
    self.docs.append({'title': self.title,
                      'body': self.body,
                      'topics': self.topics,
                      'new_id': self.attributes["newid"],
                      'lewis_split': self.attributes["lewissplit"],
                      'cgi_split': self.attributes["cgisplit"]})
    self._reset()

  def start_title(self, attributes):
    self.in_title = 1

  def end_title(self):
    self.in_title = 0

  def start_body(self, attributes):
    self.in_body = 1

  def end_body(self):
    self.in_body = 0

  def start_topics(self, attributes):
    self.in_topics = 1

  def end_topics(self):
    self.in_topics = 0

  def start_d(self, attributes):
    self.in_topic_d = 1

  def end_d(self):
    self.in_topic_d = 0
    self.topics.append(self.topic_d)
    self.topic_d = ""


def get_reuters_documents(data_path=None):
  """Iterate over documents of the Reuters dataset.
  Documents are represented as dictionaries with 'body' (str),
  'title' (str), 'topics' (list(str)) keys. Also information about the
  training and test splits and ids
  """

  parser = ReutersParser()
  for filename in glob(os.path.join(data_path, "*.sgm")):
    for doc in parser.parse(open(filename, 'rb')):
        yield doc

'''
Example usage:
document_generator = stream_reuters_documents("datasets/reuters21578/data/")
reuter_docs = list(document_generator)
'''
